<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Map Bridge</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }
    #map { width: 100%; height: 100%; min-height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    (function() {
      var params = {};
      location.search.slice(1).split('&').forEach(function(p) {
        var kv = p.split('=');
        if (kv[0]) params[decodeURIComponent(kv[0])] = decodeURIComponent((kv[1] || '').replace(/\+/g, ' '));
      });
      var ncpKeyId = params.ncpKeyId || params.ncpClientId || params.clientId || '';
      var w = parseInt(params.width, 10) || 400;
      var h = parseInt(params.height, 10) || 600;
      document.getElementById('map').style.width = w + 'px';
      document.getElementById('map').style.height = h + 'px';

      var map = null;
      var markers = [];

      function postToRN(obj) {
        if (window.ReactNativeWebView && typeof window.ReactNativeWebView.postMessage === 'function') {
          window.ReactNativeWebView.postMessage(JSON.stringify(obj));
        }
      }

      function clearMarkers() {
        markers.forEach(function(m) { m.setMap(null); });
        markers = [];
      }

      function createMarkers(list) {
        if (!map || !window.naver || !window.naver.maps) return;
        clearMarkers();
        list.forEach(function(item) {
          var position = new naver.maps.LatLng(item.lat, item.lng);
          var marker = new naver.maps.Marker({
            position: position,
            map: map,
            title: item.title || item.id,
          });
          naver.maps.Event.addListener(marker, 'click', function() {
            postToRN({ type: 'MARKER_CLICK', payload: { id: item.id, lat: item.lat, lng: item.lng } });
          });
          markers.push(marker);
        });
      }

      window.__NaverMapBridge = {
        setCenter: function(lat, lng) {
          if (!map || !window.naver || !window.naver.maps) return;
          map.setCenter(new naver.maps.LatLng(lat, lng));
        },
        setZoom: function(level) {
          if (!map) return;
          map.setZoom(level);
        },
        setMarkers: function(list) {
          createMarkers(list);
        }
      };

      function showError(msg) {
        var el = document.getElementById('map');
        if (el) {
          el.innerHTML = '<div style="padding:16px;font-size:14px;color:#c00;">' + (msg || '지도 로드 실패') + '</div>';
        }
      }

      function init() {
        if (!ncpKeyId) {
          showError('ncpKeyId가 없습니다. URL에 ncpKeyId=클라이언트ID 를 붙여 주세요.');
          postToRN({ type: 'MAP_READY' });
          return;
        }
        if (!window.naver || !window.naver.maps) {
          setTimeout(init, 50);
          return;
        }

        try {
          map = new naver.maps.Map('map', {
          center: new naver.maps.LatLng(37.5665, 126.9780),
          zoom: 14,
          zoomControl: true,
          zoomControlOptions: {
            position: naver.maps.Position.TOP_RIGHT,
          },
          mapDataControl: false,
        });

        naver.maps.Event.addListener(map, 'click', function(e) {
          var latlng = e.coord;
          postToRN({ type: 'MAP_CLICK', payload: { lat: latlng.y, lng: latlng.x } });
        });

        naver.maps.Event.addListener(map, 'idle', function() {
          var center = map.getCenter();
          postToRN({
            type: 'MAP_MOVE_END',
            payload: { lat: center.y, lng: center.x, level: map.getZoom() }
          });
        });

        postToRN({ type: 'MAP_READY' });
        } catch (e) {
          showError('지도 생성 실패: ' + (e && e.message ? e.message : String(e)));
          postToRN({ type: 'MAP_READY' });
        }
      }

      if (!ncpKeyId) {
        init();
        return;
      }

      var script = document.createElement('script');
      script.src = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=' + encodeURIComponent(ncpKeyId);
      script.onload = init;
      script.onerror = function() {
        showError('네이버 지도 스크립트 로드 실패. NCP Web 서비스 URL 등록 및 Dynamic Map 활성화를 확인하세요.');
        postToRN({ type: 'MAP_READY' });
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>
